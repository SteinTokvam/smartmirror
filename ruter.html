<!DOCTYPE html>
<html>
<head>
<title>Ruter</title>
<meta charset="UTF-8">

<script>

function start(){
  startFetching();
}

var slemdal = 3012330;
var stasjonsveien = 3012335;
var station_id = 3012330;
var busOrMetro = "Linje "
var id = ["line", "aimed", "expected"];

function startFetching(){
  sendRequest();
  setTimeout(startFetching, 60000);//reload 1 gang hver minutt
}
function sendRequest(){
  var xhr = new XMLHttpRequest();

  xhr.open("GET", "http://reisapi.ruter.no/Place/GetStop/" + station_id, false);
  xhr.send();

  xhr.open("GET", "http://reisapi.ruter.no/StopVisit/GetDepartures/" + station_id, false);
  xhr.send();

  var responseToGET = xhr.responseText;
  responseToGET = responseToGET.split(",");

  printAll(responseToGET);
}

function changeID(i){
  if(station_id == stasjonsveien){
    if(i == 0){
      busOrMetro = "Buss "
      id[0] = "46line";
      id[1] = "46aimed";
      id[2] = "46expected";
    }else{
      id[0] = "46line";
      id[1] = "46aimed2";
      id[2] = "46expected2";
    }
  }else if(i == 0){
    busOrMetro = "Linje "
    id[0] = "line";
    id[1] = "aimed";
    id[2] = "expected";
  }else{
    id[0] = "line";
    id[1] = "aimed2";
    id[2] = "expected2";
  }
}

function printAll(responseToGET){
  var maxResults = 2;
  var currResults = 0;
  changeID(0);
  for(i = 0; i < responseToGET.length; i ++){
    if(responseToGET[i] == "\"DirectionName\":\"1\""){//hvilken retning kollektiven gÃ¥r.. 1=sentrum, 2=andre veien
      currResults++;

      var linjenr = responseToGET[i-1].split(":");

      var linjeTall = parseInt(linjenr[1].charAt(1) + linjenr[1].charAt(2));
      document.getElementById(id[0]).innerHTML = busOrMetro + linjeTall;

      var aimedArrival = responseToGET[i+19].split("T");
      var timeAimedArrival = aimedArrival[2].split("+");

      document.getElementById(id[1]).innerHTML = timeAimedArrival[0];

      var expectedArrival = responseToGET[i+20].split("T");
      var timeExpectedArrival = expectedArrival[2].split("+");
      document.getElementById(id[2]).innerHTML = timeExpectedArrival[0];
      changeID(1);
      if(currResults == maxResults){
        if(station_id == stasjonsveien){
          station_id = slemdal;
          break;
        }
        station_id = stasjonsveien;

        sendRequest();
        break;
      }
    }
  }
}
</script>
</head>
<body onload="start()">
  <table style="width:100%">
    <tr>
      <th id="line">Firstname</th>
      <th>Forventes</th>
      <th>Sanntid</th>
    </tr>
    <tr>
      <th></th>
      <th id="aimed">Lastname</th>
      <th id="expected">Age</th>
    </tr>
    <tr>
      <th></th>
      <th id="aimed2">Lastname</th>
      <th id="expected2">Age</th>
    </tr>

      <tr>
        <th id="46line">Firstname</th>
        <th>Forventes</th>
        <th>Sanntid</th>
      </tr>
      <tr>
        <th></th>
        <th id="46aimed">Lastname</th>
        <th id="46expected">Age</th>
      </tr>
      <tr>
        <th></th>
        <th id="46aimed2">Lastname</th>
        <th id="46expected2">Age</th>
      </tr>
    </table>




</body>
</html>
