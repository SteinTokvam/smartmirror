<!DOCTYPE html>
<html>
<head>
<style>
a {
  color: white;
}

p{
  font-family: arial;
}
</style>
<script>

function start(){
  startFetching();
  startTime();
}

function startTime() {
    var today = new Date();
    var dayNumber = today.getDay();
    var date = today.getDate();

    var month = today.getMonth() + 1;

    var year = today.getFullYear();
    var h = today.getHours();
    var m = today.getMinutes();
    var s = today.getSeconds();
    m = checkTime(m);
    s = checkTime(s);
    month = setMonth(month);
    var dayText = setDay(dayNumber);

    document.getElementById('date').innerHTML = dayText + " " + date + ". " + month + " " + year;
    document.getElementById('time').innerHTML = h + ":" + m + ":" + s;

    var t = setTimeout(startTime, 500);
}

function getRandom(){
  return Math.floor((Math.random() * 103) +1);
}

function checkTime(i) {
    if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
    return i;
}

function setDay(day){
	if(day == 1){day = "Mandag"}
    else if(day == 2){day = "Tirsdag"}
    else if(day == 3){day = "Onsdag"}
    else if(day == 4){day = "Torsdag"}
    else if(day == 5){day = "Fredag"}
    else if(day == 6){day = "L&#248;rdag"}
    else if(day == 0){day = "S&#248;ndag"};
    return day;
}

function setMonth(month){
	if(month == 1){month = "Januar"}
    else if(month == 2){month = "Februar"}
    else if(month == 3){month = "Mars"}
    else if(month == 4){month = "April"}
    else if(month == 5){month = "Mai"}
    else if(month == 6){month = "Juni"}
    else if(month == 7){month = "Juli"}
    else if(month == 8){month = "August"}
    else if(month == 9){month = "September"}
    else if(month == 10){month = "Oktober"}
    else if(month == 11){month = "November"}
    else if(month == 12){month = "Desember"};
    return month;
}

function textFileToArray( filename )
{
    var reader = (window.XMLHttpRequest != null )
               ? new XMLHttpRequest()
               : new ActiveXObject("Microsoft.XMLHTTP");
    reader.open("GET", filename, false );
    reader.send( );
    return reader.responseText.split(/(\r\n|\n)/g);
}

//end time script

var slemdal = 3012330;
var stasjonsveien = 3012335;
var station_id = 3012330;
var busOrMetro = "Linje "
var id = ["line", "aimed", "expected"];

function startFetching(){
  sendRequest();
  setTimeout(startFetching, 60000);//reload 1 gang hver minutt
}
function sendRequest(){
  var xhr = new XMLHttpRequest();


  xhr.open("GET", "http://reisapi.ruter.no/StopVisit/GetDepartures/" + station_id, false);
  xhr.send();

  var responseToGET = xhr.responseText;
  responseToGET = responseToGET.split(",");

  printAll(responseToGET);
}

function changeID(i){
  if(station_id == stasjonsveien){
    if(i == 0){
      busOrMetro = "Buss "
      id[0] = "46line";
      id[1] = "46aimed";
      id[2] = "46expected";
    }else{
      id[0] = "46line";
      id[1] = "46aimed2";
      id[2] = "46expected2";
    }
  }else if(i == 0){
    busOrMetro = "Linje "
    id[0] = "line";
    id[1] = "aimed";
    id[2] = "expected";
  }else{
    id[0] = "line";
    id[1] = "aimed2";
    id[2] = "expected2";
  }
}

function printAll(responseToGET){
  var maxResults = 2;
  var currResults = 0;
  var date = new Date();
  var minutes = date.getMinutes();
  var seconds = date.getSeconds();
  changeID(0);
  for(i = 0; i < responseToGET.length; i ++){
    if(responseToGET[i] == "\"DirectionName\":\"1\""){//hvilken retning kollektiven går.. 1=sentrum, 2=andre veien
      currResults++;

      var linjenr = responseToGET[i-1].split(":");

      var linjeTall = parseInt(linjenr[1].charAt(1) + linjenr[1].charAt(2));
      document.getElementById(id[0]).innerHTML = busOrMetro + linjeTall;

      var aimedArrival = responseToGET[i+19].split("T");
      var timeAimedArrival = aimedArrival[2].split("+");

      document.getElementById(id[1]).innerHTML = timeAimedArrival[0];

      var expectedArrival = responseToGET[i+20].split("T");
      var timeExpectedArrival = expectedArrival[2].split("+");
      var minute = timeExpectedArrival[0].split(":");
      var second = minute[2];
      minute = 22;
      //minute = minute[1];
      //document.write("clock: " + minutes + ":" + seconds + " - - " + minute + ":" + second);
      var secondCalc = second - seconds;
      var waitUntilRuter = minute - minutes;
      if(secondCalc>29){
        waitUntilRuter++;
      }
      if(secondCalc<40 && minute == 1){
        waitUntilRuter = "nå!";
        //denne delen fungerer ikke, men ellers så er den der..kommenter frem igjen document.write
      }
    //  document.write("ruter:   " + waitUntilRuter);
      document.getElementById(id[2]).innerHTML = timeExpectedArrival[0];
      changeID(1);
      if(currResults == maxResults){
        if(station_id == stasjonsveien){
          station_id = slemdal;
          break;
        }
        station_id = stasjonsveien;

        sendRequest();
        break;
      }
    }
  }
}

</script>
</head>

<body onload="start()" style="background-color:black;">
  <div class="content" style="width:800px; heigth:400px; margin-bottom:250px;">
    <div class="left-content" style="width:400; height:400; ">
      <font color="white"><div id="time" style="padding-bottom:20px; font-size:50pt; "> </div></font>
      <font color="white"><div id="date" style="font-size:20pt; "> </div></font>
    </div>
    <div class="weather" style="width:130px; height: 200px; font-size:15pt; float:right; margin-top:-150px; margin-right:50px;">
      <font color="white"><script src="http://www.yr.no/sted/Norge/Oslo/Oslo/Ris_kirke/ekstern_boks_stripe.js"></script><noscript><a href="http://www.yr.no/sted/Norge/Oslo/Oslo/Ris_kirke/">yr.no: Værvarsel for Ris kirke</a></noscript></font>
    </div>
    <div class="ruter" style="margin-top:200px;">
      <font color="white">
        <table style="width:100%">
          <tr>
            <th id="line">Firstname</th>
            <th>Forventes</th>
            <th>Sanntid</th>
          </tr>
          <tr>
            <th></th>
            <th id="aimed">Lastname</th>
            <th id="expected">Age</th>
          </tr>
          <tr>
            <th style="border-bottom: 2px dotted white;"></th>
            <th id="aimed2" style="border-bottom: 2px dotted white;">Lastname</th>
            <th id="expected2" style="border-bottom: 2px dotted white;">Age</th>
          </tr>

            <tr>
              <th id="46line">Firstname</th>
              <th>Forventes</th>
              <th>Sanntid</th>
            </tr>
            <tr>
              <th></th>
              <th id="46aimed">Lastname</th>
              <th id="46expected">Age</th>
            </tr>
            <tr>
              <th></th>
              <th id="46aimed2">Lastname</th>
              <th id="46expected2">Age</th>
            </tr>
          </table>
        </font>
      </div>
  </div>
</body>
</html>
